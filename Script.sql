CREATE DATABASE Bodega;
GO
USE Bodega;
GO

CREATE TABLE Sucursales(
    SucursalID INT IDENTITY(1,1) NOT NULL,
    Descripcion VARCHAR(100) NOT NULL,
    Direccion   VARCHAR(100) NOT NULL,
    Estado      VARCHAR(1) NOT NULL DEFAULT 'A'
);
GO
CREATE TABLE Productos (
    ProductoID INT IDENTITY(1,1) NOT NULL,
    Descripcion	VARCHAR(100) NOT NULL,
    Estado 	VARCHAR(1) NOT NULL DEFAULT 'A'
);
GO
CREATE TABLE Lotes (
    LoteID INT IDENTITY(1,1) NOT NULL,
    ProductoID INT NOT NULL,
    FechaVencimiento    DATE NOT NULL,
    Costo DECIMAL(5,2) NOT NULL,
    Cantidad    INT NOT NULL DEFAULT 0
);
GO

CREATE TABLE SalidaEnc (
    SalidaID INT IDENTITY(1,1) NOT NULL,
    SucursalID INT NOT NULL,
    Fecha DATETIME NOT NULL DEFAULT GETDATE(),
    FechaRecibido DATETIME DEFAULT NULL,
    UsuarioID NVARCHAR(450) NOT NULL,
    UsuarioRecibe NVARCHAR(450) NULL,
    Estado VARCHAR(1) NOT NULL DEFAULT 'E'
);
GO
CREATE TABLE SalidaDet (
	SalidaID INT NOT NULL,
	LoteID INT NOT NULL,
	Cantidad    INT NOT NULL,
	Costo DECIMAL(5,2) NOT NULL
);
GO
-- constraints
-- Llave Primaria
ALTER TABLE Sucursales ADD CONSTRAINT pkSucursalID PRIMARY KEY(SucursalID);
GO
ALTER TABLE Productos ADD CONSTRAINT pkProductosID PRIMARY KEY(ProductoID);
GO
ALTER TABLE Lotes ADD CONSTRAINT pkLotesID PRIMARY KEY(LoteID);
GO
ALTER TABLE SalidaEnc ADD CONSTRAINT pkSalidaEncID PRIMARY KEY(SalidaID);
GO
ALTER TABLE SalidaDet ADD CONSTRAINT pkSalidaDetID PRIMARY KEY(SalidaID, LoteID);
GO

--llave foranea
ALTER TABLE Lotes ADD CONSTRAINT fkLotesProductoID FOREIGN KEY (ProductoID) REFERENCES Productos(ProductoID);
GO
ALTER TABLE SalidaEnc ADD CONSTRAINT fkSalidaEncSucursalID FOREIGN KEY (SucursalID) REFERENCES Sucursales(SucursalID);
GO
ALTER TABLE SalidaDet ADD CONSTRAINT fkSalidaDetSalidaID FOREIGN KEY (SalidaID) REFERENCES SalidaEnc(SalidaID);
GO
ALTER TABLE SalidaDet ADD CONSTRAINT fkSalidaDetLoteID FOREIGN KEY (LoteID) REFERENCES Lotes(LoteID);

-- Constraint Check
GO
ALTER TABLE Productos ADD CONSTRAINT ckProductosEstado CHECK (estado IN('A','I','B'));
GO
ALTER TABLE Sucursales ADD CONSTRAINT ckSucursalesEstado CHECK (Estado IN('A','I','B'));
GO
ALTER TABLE SalidaEnc ADD CONSTRAINT ckSalidaEncEstado CHECK (Estado IN('E','R','B'));
GO
ALTER TABLE Lotes ADD CONSTRAINT ckLotesCantidad CHECK (Cantidad>-1);
GO
ALTER TABLE Lotes ADD CONSTRAINT ckLotesCosto CHECK (Costo>0);
GO
ALTER TABLE SalidaDet ADD CONSTRAINT ckSalidaDetCantidad CHECK (Cantidad>0);
GO
ALTER TABLE SalidaDet ADD CONSTRAINT ckSalidaDetCosto CHECK (Costo>0);
GO
ALTER TABLE SalidaEnc ADD CONSTRAINT ckSalidaEncFechaRecibido CHECK (FechaRecibido IS NULL OR Fecha < FechaRecibido);
GO

-- Identity

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[AspNetUsers](
	[Id] [nvarchar](450) NOT NULL,
	[NombreCompleto] [nvarchar](max) NOT NULL,
	[RoleId] [nvarchar](450) NULL,
	[Estado] [varchar](1) NOT NULL,
	[UserName] [nvarchar](256) NULL,
	[NormalizedUserName] [nvarchar](256) NULL,
	[Email] [nvarchar](256) NULL,
	[NormalizedEmail] [nvarchar](256) NULL,
	[EmailConfirmed] [bit] NOT NULL,
	[PasswordHash] [nvarchar](max) NULL,
	[SecurityStamp] [nvarchar](max) NULL,
	[ConcurrencyStamp] [nvarchar](max) NULL,
	[PhoneNumber] [nvarchar](max) NULL,
	[PhoneNumberConfirmed] [bit] NOT NULL,
	[TwoFactorEnabled] [bit] NOT NULL,
	[LockoutEnd] [datetimeoffset](7) NULL,
	[LockoutEnabled] [bit] NOT NULL,
	[AccessFailedCount] [int] NOT NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
ALTER TABLE [dbo].[AspNetUsers] ADD  CONSTRAINT [PK_AspNetUsers] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
CREATE NONCLUSTERED INDEX [EmailIndex] ON [dbo].[AspNetUsers]
(
	[NormalizedEmail] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
CREATE NONCLUSTERED INDEX [IX_AspNetUsers_RoleId] ON [dbo].[AspNetUsers]
(
	[RoleId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
CREATE UNIQUE NONCLUSTERED INDEX [UserNameIndex] ON [dbo].[AspNetUsers]
(
	[NormalizedUserName] ASC
)
WHERE ([NormalizedUserName] IS NOT NULL)
WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
ALTER TABLE [dbo].[AspNetUsers] ADD  DEFAULT ('A') FOR [Estado]
GO
ALTER TABLE [dbo].[AspNetUsers]  WITH CHECK ADD  CONSTRAINT [FK_AspNetUsers_AspNetRoles_RoleId] FOREIGN KEY([RoleId])
REFERENCES [dbo].[AspNetRoles] ([Id])
GO
ALTER TABLE [dbo].[AspNetUsers] CHECK CONSTRAINT [FK_AspNetUsers_AspNetRoles_RoleId]
GO
ALTER TABLE [dbo].[AspNetUsers]  WITH CHECK ADD  CONSTRAINT [ckUsuarioEstado] CHECK  (([Estado]='B' OR [Estado]='I' OR [Estado]='A'))
GO
ALTER TABLE [dbo].[AspNetUsers] CHECK CONSTRAINT [ckUsuarioEstado]
GO

CREATE TABLE [dbo].[AspNetUserRoles](
	[UserId] [nvarchar](450) NOT NULL,
	[RoleId] [nvarchar](450) NOT NULL
) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
ALTER TABLE [dbo].[AspNetUserRoles] ADD  CONSTRAINT [PK_AspNetUserRoles] PRIMARY KEY CLUSTERED 
(
	[UserId] ASC,
	[RoleId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
CREATE NONCLUSTERED INDEX [IX_AspNetUserRoles_RoleId] ON [dbo].[AspNetUserRoles]
(
	[RoleId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
ALTER TABLE [dbo].[AspNetUserRoles]  WITH CHECK ADD  CONSTRAINT [FK_AspNetUserRoles_AspNetRoles_RoleId] FOREIGN KEY([RoleId])
REFERENCES [dbo].[AspNetRoles] ([Id])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[AspNetUserRoles] CHECK CONSTRAINT [FK_AspNetUserRoles_AspNetRoles_RoleId]
GO
ALTER TABLE [dbo].[AspNetUserRoles]  WITH CHECK ADD  CONSTRAINT [FK_AspNetUserRoles_AspNetUsers_UserId] FOREIGN KEY([UserId])
REFERENCES [dbo].[AspNetUsers] ([Id])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[AspNetUserRoles] CHECK CONSTRAINT [FK_AspNetUserRoles_AspNetUsers_UserId]
GO

CREATE TABLE [dbo].[AspNetUserLogins](
	[LoginProvider] [nvarchar](450) NOT NULL,
	[ProviderKey] [nvarchar](450) NOT NULL,
	[ProviderDisplayName] [nvarchar](max) NULL,
	[UserId] [nvarchar](450) NOT NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
ALTER TABLE [dbo].[AspNetUserLogins] ADD  CONSTRAINT [PK_AspNetUserLogins] PRIMARY KEY CLUSTERED 
(
	[LoginProvider] ASC,
	[ProviderKey] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
CREATE NONCLUSTERED INDEX [IX_AspNetUserLogins_UserId] ON [dbo].[AspNetUserLogins]
(
	[UserId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
ALTER TABLE [dbo].[AspNetUserLogins]  WITH CHECK ADD  CONSTRAINT [FK_AspNetUserLogins_AspNetUsers_UserId] FOREIGN KEY([UserId])
REFERENCES [dbo].[AspNetUsers] ([Id])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[AspNetUserLogins] CHECK CONSTRAINT [FK_AspNetUserLogins_AspNetUsers_UserId]
GO

CREATE TABLE [dbo].[AspNetUserClaims](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[UserId] [nvarchar](450) NOT NULL,
	[ClaimType] [nvarchar](max) NULL,
	[ClaimValue] [nvarchar](max) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
ALTER TABLE [dbo].[AspNetUserClaims] ADD  CONSTRAINT [PK_AspNetUserClaims] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
CREATE NONCLUSTERED INDEX [IX_AspNetUserClaims_UserId] ON [dbo].[AspNetUserClaims]
(
	[UserId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
ALTER TABLE [dbo].[AspNetUserClaims]  WITH CHECK ADD  CONSTRAINT [FK_AspNetUserClaims_AspNetUsers_UserId] FOREIGN KEY([UserId])
REFERENCES [dbo].[AspNetUsers] ([Id])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[AspNetUserClaims] CHECK CONSTRAINT [FK_AspNetUserClaims_AspNetUsers_UserId]
GO

CREATE TABLE [dbo].[AspNetRoles](
	[Id] [nvarchar](450) NOT NULL,
	[Name] [nvarchar](256) NULL,
	[NormalizedName] [nvarchar](256) NULL,
	[ConcurrencyStamp] [nvarchar](max) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
ALTER TABLE [dbo].[AspNetRoles] ADD  CONSTRAINT [PK_AspNetRoles] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
CREATE UNIQUE NONCLUSTERED INDEX [RoleNameIndex] ON [dbo].[AspNetRoles]
(
	[NormalizedName] ASC
)
WHERE ([NormalizedName] IS NOT NULL)
WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

CREATE TABLE [dbo].[AspNetRoleClaims](
	[Id] [int] IDENTITY(1,1) NOT NULL,
	[RoleId] [nvarchar](450) NOT NULL,
	[ClaimType] [nvarchar](max) NULL,
	[ClaimValue] [nvarchar](max) NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
ALTER TABLE [dbo].[AspNetRoleClaims] ADD  CONSTRAINT [PK_AspNetRoleClaims] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
SET ANSI_PADDING ON
GO
CREATE NONCLUSTERED INDEX [IX_AspNetRoleClaims_RoleId] ON [dbo].[AspNetRoleClaims]
(
	[RoleId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO
ALTER TABLE [dbo].[AspNetRoleClaims]  WITH CHECK ADD  CONSTRAINT [FK_AspNetRoleClaims_AspNetRoles_RoleId] FOREIGN KEY([RoleId])
REFERENCES [dbo].[AspNetRoles] ([Id])
ON DELETE CASCADE
GO
ALTER TABLE [dbo].[AspNetRoleClaims] CHECK CONSTRAINT [FK_AspNetRoleClaims_AspNetRoles_RoleId]
GO

ALTER TABLE SalidaEnc ADD CONSTRAINT fkSalidaEncUsuarioID FOREIGN KEY(UsuarioID) REFERENCES AspNetUsers(Id);
GO
ALTER TABLE SalidaEnc ADD CONSTRAINT fkSalidaEncUsuarioRecibe FOREIGN KEY(UsuarioRecibe) REFERENCES AspNetUsers(Id);
GO

INSERT INTO "AspNetRoles" ("Id","Name","NormalizedName","ConcurrencyStamp")
VALUES
('51df7aae-a506-46ff-8e34-9f2f0c661885','ADMINBODEGA','ADMINBODEGA',NULL),
('368cb24e-03d3-4a01-b558-dbde9b33272c','CLIENT','CLIENT',NULL);
GO

INSERT INTO Sucursales (Descripcion,Direccion)
VALUES
('CENTRO','BO. CENTRO'),
('ALTARA','MALL ALTARA'),
('GALERIAS','MALL GALERIAS DEL VALLE'),
('MEGAMALL','MALL MEGAMALL');
GO 

--select @@VERSION

INSERT INTO Productos (Descripcion)
VALUES
('ALKAZERSER'),
('JARABE PARA LA TOS'),
('PANADOL');
GO

INSERT INTO Lotes (ProductoID,FechaVencimiento,Costo,Cantidad)
VALUES
(1,'2027-10-1',10,100),
(1,'2025-11-1',10,50),
(1,'2026-12-1',10,100),
(2,'2027-1-1',100,500),
(2,'2027-2-1',100,500),
(2,'2025-12-1',100,250),
(3,'2025-11-1',25,0),
(3,'2025-12-1',25,100);
GO


/*USE master;
GO
ALTER DATABASE Bodega SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
GO
DROP DATABASE Bodega;
GO*/

